specVersion: 0.1.0
description: Test WASM substream
codeType: wasm/rust-v1

startBlock: 6810706

protoFiles:
- ./proto/pcs.proto
- ./proto/tokens.proto

modules:
- name: block_to_pairs
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_pairs
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:pcs.types.v1.Pairs

- name: pairs
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_pairs_state
  inputs:
    - map: block_to_pairs
  output:
    updatePolicy: replace
    valueType: bytes

- name: block_to_reserves
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_reserves
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
  output:
    type: proto:pcs.types.v1.Reserves

- name: reserves
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_reserves_state
  inputs:
    - map: block_to_reserves
    - store: pairs
  output:
    updatePolicy: replace
    valueType: string

#- name: block_to_tokens
#  kind: map
#  code:
#    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
#    entrypoint: block_to_tokens
#  inputs:
#    - source: sf.ethereum.type.v1.Block
#  output:
#    type: proto:sf.substreams.tokens.v1.Tokens

#- name: tokens
#  kind: store
#  code:
#    file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
#    entrypoint: build_tokens_state
#  inputs:
#    - map: block_to_tokens
#  output:
#    updatePolicy: replace
#    valueType: bytes
# - name: db_out
#   kind: map
#   code:
#     file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
#     entrypoint: map_to_database
#   inputs:
#     - map: reserves_extractor
#     - store: pairs
#       mode: deltas
#     - store: pairs ## Expose `get_at`, `get_first` and `get_last`
#       mode: get
#   output:
#     type: proto:sf.substreams.v1.DebeziumCDC
