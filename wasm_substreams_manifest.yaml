specVersion: 0.1.0
description: Test WASM substream
codeType: wasm/rust-v1

startBlock: 6810706

protoFiles:
- ./proto/pcs.proto
- ./proto/tokens.proto

modules:
- name: block_to_pairs
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_pairs
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:pcs.types.v1.Pairs

- name: pairs
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_pairs_state
  inputs:
    - map: block_to_pairs
  output:
    updatePolicy: replace
    valueType: bytes

- name: block_to_reserves
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_reserves
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
  output:
    type: proto:pcs.types.v1.Reserves

- name: reserves
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_reserves_state
  inputs:
    - map: block_to_reserves
    - store: pairs
  output:
    updatePolicy: replace
    valueType: string

- name: prices
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_prices_state
  inputs:
    - map: block_to_reserves
    - store: pairs
    - store: reserves
  output:
    updatePolicy: replace
    valueType: string

- name: mint_burn_swaps_extractor
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_mint_burn_swaps
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
    - store: prices
  output:
    type: proto:pcs.types.v1.MintBurnSwaps

- name: totals
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_totals_state
  inputs:
    - map: block_to_pairs
    - map: mint_burn_swaps_extractor
  output:
    updatePolicy: sum
    valueType: int64

- name: volumes
  kind: store
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_volumes_state
  inputs:
    - source: sf.ethereum.type.v1.block
    - map: mint_burn_swaps_extractor
  output:
    updatePolicy: sum
    valueType: bigfloat

- name: block_to_tokens
  kind: map
  code:
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: block_to_tokens
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:sf.substreams.tokens.v1.Tokens

- name: tokens
  kind: store
  code:
    file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
    entrypoint: build_tokens_state
  inputs:
    - map: block_to_tokens
  output:
    updatePolicy: replace
    valueType: bytes
#
# - name: db_out
#   kind: map
#   code:
#     file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
#     entrypoint: map_to_database
#   inputs:
#     - map: reserves_extractor
#     - store: pairs
#       mode: deltas
#     - store: pairs ## Expose `get_at`, `get_first` and `get_last`
#       mode: get
#   output:
#     type: proto:sf.substreams.v1.DebeziumCDC
