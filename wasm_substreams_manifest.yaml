specVersion: 0.1.0
description: Test WASM substream

protoFiles:
- ./proto/pcs.proto
- ./proto/tokens.proto

modules:
- name: block_to_pairs
  kind: map
  startBlock: 6810706
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_pairs
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:pcs.types.v1.Pairs

- name: pairs
  kind: store
  startBlock: 6810706
  updatePolicy: replace
  valueType: proto:pcs.types.v1.Pair
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_pairs_state
  inputs:
    - map: block_to_pairs

- name: block_to_reserves
  kind: map
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_reserves
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
  output:
    type: proto:pcs.types.v1.Reserves

- name: reserves
  kind: store
  updatePolicy: replace
  valueType: string
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_reserves_state
  inputs:
    - map: block_to_reserves
    - store: pairs

- name: prices
  kind: store
  updatePolicy: replace
  valueType: string
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_prices_state
  inputs:
    - map: block_to_reserves
    - store: pairs
    - store: reserves

- name: mint_burn_swaps_extractor
  kind: map
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: map_mint_burn_swaps
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
    - store: prices
    - store: tokens
  output:
    type: proto:pcs.types.v1.MintBurnSwaps

- name: totals
  kind: store
  updatePolicy: sum
  valueType: int64
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_totals_state
  inputs:
    - map: block_to_pairs
    - map: mint_burn_swaps_extractor

- name: volumes
  kind: store
  updatePolicy: sum
  valueType: bigfloat
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: build_volumes_state
  inputs:
    - source: sf.ethereum.type.v1.block
    - map: mint_burn_swaps_extractor

- name: block_to_tokens
  kind: map
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/target/wasm32-unknown-unknown/release/pcs_substreams.wasm
    entrypoint: block_to_tokens
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:sf.substreams.tokens.v1.Tokens

- name: tokens
  kind: store
  updatePolicy: replace
  valueType: bytes
  code:
    type: wasm/rust-v1
    file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
    entrypoint: build_tokens_state
  inputs:
    - map: block_to_tokens

 - name: db_out
   kind: map
   code:
     file: ./pcs-rust/pkg/pcs_substreams_bg.wasm
     entrypoint: map_to_database
   inputs:
     - store: tokens
       mode: deltas
     - store: pairs
       mode: deltas
     - map: reserves_extractor
   output:
     type: proto:sf.substreams.v1.DebeziumCDC
