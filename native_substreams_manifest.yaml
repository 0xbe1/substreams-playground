specVersion: 0.1.0
description: PancakeSwap substreams
codeType: native

genesisBlock: 6809737

protoFiles:
- ./pancakeswap.proto

streams:
- name: pair_extractor
  kind: Mapper
  code:
    native: pcs_pair_extractor
  inputs:
  - proto:sf.ethereum.types.v1.Block
  output:
    type: proto:pcs.types.v1.Pairs

- name: pairs
  kind: StateBuilder
  code:
    native: pcs_pairs_state_builder
  inputs:
  - stream:pair_extractor
  output:
    updatePolicy: replace
    valueType: string

- name: reserves_extractor
  kind: Mapper
  code:
    native: pcs_reserves_extractor
  inputs:
  - proto:sf.ethereum.types.v1.Block
  - store:pairs
  output:
    type: proto:pcs.types.v1.ReserveUpdates

- name: reserves
  kind: StateBuilder
  code:
    native: pcs_reserves_state_builder
  inputs:
  - stream:reserves_extractor
  - store:pairs
  output:
    updatePolicy: replace
    valueType: bigfloat

- name: prices
  kind: StateBuilder
  code:
    native: pcs_derived_prices_state_builder
  inputs:
    - stream:reserves_extractor
    - store:pairs
    - store:reserves
  output:
    # What to do when a previous key already exists
    updatePolicy: max         # Exposes SetMaxInt|Float|Uint64|Int64|
    updatePolicy: min         # Exposes SetMinInt|Float|...
    updatePolicy: sum         # Exposes SumInt|Float|
    updatePolicy: replace     # Exposes Set(), compatible with
    updatePolicy: ignore      # Exposes SetIfNotExists()
    valueType: bigint
    valueType: int64
    valueType: bigfloat
    valueType: float64
    valueType: bytes
    valueType: string
    valueType: proto
    protoType: pcs.types.v1.ReserveUpdate

- name: mint_burn_swaps_extractor
  kind: Mapper
  code:
    native: pcs_mint_burn_swaps_extractor
  inputs:
  - proto:sf.ethereum.types.v1.Block
  - store:pairs
  - store:prices
  output:
    type: proto:pcs.types.v1.MintBurnSwaps

- name: totals
  kind: StateBuilder
  code:
    native: pcs_totals_state_builder
  inputs:
  - stream:pair_extractor
  - stream:mint_burn_swaps_extractor
  output:
    updatePolicy:
    valueType: INT_DELTA

- name: volumes
  kind: StateBuilder
  code:
    native: pcs_volumes_state_builder
  inputs:
  - proto:sf.ethereum.types.v1.Block  # Only needed for Number/Timestamp, so a smaller stream would be just as fine.
  - stream:mint_burn_swaps_extractor
  output:
    dataType: FLOAT_DELTA


# $ program manifest.yaml pairsExtractor
