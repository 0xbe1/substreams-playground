specVersion: 0.1.0
description: PancakeSwap substreams
startBlock: 6810706

protoFiles:
- ./proto/pcs.proto

modules:
- name: block_to_pairs
  kind: map
  code:
    type: native
    entrypoint: pcs_pair_extractor
  inputs:
    - source: sf.ethereum.type.v1.Block
  output:
    type: proto:pcs.types.v1.Pairs

- name: pairs
  kind: store
  updatePolicy: replace
  valueType: string
  code:
    type: native
    entrypoint: pcs_pairs_state_builder
  inputs:
    - map: block_to_pairs

- name: block_to_reserves
  kind: map
  code:
    type: native
    entrypoint: pcs_reserves_extractor
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
  output:
    type: proto:pcs.types.v1.ReserveUpdates

- name: reserves
  kind: store
  updatePolicy: replace
  valueType: string
  code:
    type: native
    entrypoint: pcs_reserves_state_builder
  inputs:
    - map: block_to_reserves
    - store: pairs

- name: prices
  kind: store
  updatePolicy: replace
  valueType: string
  code:
    type: native
    entrypoint: pcs_derived_prices_state_builder
  inputs:
    - map: block_to_reserves
    - store: pairs
    - store: reserves

- name: mint_burn_swaps_extractor
  kind: map
  code:
    type: native
    entrypoint: pcs_mint_burn_swaps_extractor
  inputs:
    - source: sf.ethereum.type.v1.Block
    - store: pairs
    - store: prices
  output:
    type: proto:pcs.types.v1.MintBurnSwaps

- name: totals
  kind: store
  updatePolicy: sum
  valueType: int64
  code:
    type: native
    entrypoint: pcs_totals_state_builder
  inputs:
    - map: block_to_pairs
    - map: mint_burn_swaps_extractor

- name: volumes
  kind: store
  updatePolicy: sum
  valueType: bigfloat
  code:
    type: native
    entrypoint: pcs_volumes_state_builder
  inputs:
    - source: sf.ethereum.type.v1.Block  # Only needed for Number/Timestamp, so a smaller stream would be just as fine.
    - map: mint_burn_swaps_extractor

#- name: database_output
#  kind: map
#  inputs:
#    - store: volumes
#      mode: get
#    - store: volumes
#      mode: deltas
#    - map: mint_burn_swaps_extractor
#  output:
#    type: sf.substreams.v1.DebeziumCDC

# $ program manifest.yaml pairsExtractor
